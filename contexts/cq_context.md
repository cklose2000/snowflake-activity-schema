# Snowflake Claude Logs Schema Context for CQ

## Database Structure
- **Database**: CLAUDE_LOGS
- **Schema**: ACTIVITIES

## Core Tables

### ACTIVITY_STREAM (Main Event Table)
Primary table for all Claude activity events.

**Columns**:
- `activity_id` (VARCHAR): Unique identifier for each activity
- `ts` (TIMESTAMP): When the activity occurred
- `activity` (VARCHAR): Type of activity (e.g., 'claude_session_start', 'claude_session_end', 'claude_tool_use')
- `customer` (VARCHAR): Session ID or user identifier
- `anonymous_customer_id` (VARCHAR): Machine hostname
- `feature_json` (VARIANT): JSON object with activity details

**Common activity types**:
- `claude_session_start`: Beginning of a Claude session
- `claude_session_end`: End of a Claude session (often missing due to Ctrl+C)
- `claude_tool_use`: Tool invocation (bash, file read, etc.)
- `claude_meta_query`: Query generated by cq command
- `claude_prompt`: User prompt to Claude
- `claude_response`: Claude's response

## Executive Views

### V_EXECUTIVE_SUMMARY
High-level metrics dashboard for executives.

**Columns**:
- `REPORT_DATE` (DATE): Date of the report
- `LAST_UPDATED` (TIMESTAMP): When data was last refreshed
- `TOTAL_SESSIONS` (NUMBER): Total Claude sessions
- `UNIQUE_USERS` (NUMBER): Count of unique users
- `TOTAL_ACTIVITIES` (NUMBER): Total logged activities
- `TOOL_EXECUTIONS` (NUMBER): Count of tool uses
- `FILE_OPERATIONS` (NUMBER): Count of file operations
- `ERRORS_ENCOUNTERED` (NUMBER): Count of errors
- `TOTAL_COST_USD` (FLOAT): Estimated total cost
- `AVG_COST_PER_ACTIVITY` (FLOAT): Average cost per activity
- `DAYS_ACTIVE` (NUMBER): Number of days with activity
- `PROJECTS_TOUCHED` (NUMBER): Count of projects/repos
- `GIT_BRANCHES_WORKED` (NUMBER): Count of git branches
- `AVG_RESPONSE_TIME_MS` (NUMBER): Average response time
- `MAX_RESPONSE_TIME_MS` (NUMBER): Maximum response time
- `TOTAL_TOKENS_CONSUMED` (NUMBER): Total tokens used

**Use for**: Overall usage metrics, cost analysis, adoption tracking
**Key metrics**: Total sessions, unique users, total activities, estimated costs

**Example queries**:
- "Show me executive metrics"
- "What's our total Claude usage?"
- "Calculate estimated costs"

### V_RECENT_ACTIVITIES
Shows last 100 activities in reverse chronological order.

**Use for**: Real-time monitoring, debugging, recent activity review
**Columns**: All ACTIVITY_STREAM columns, formatted for readability

## Learning Views (80% Orphan Rate is Intentional)

### V_LEARNING_ORPHANED_SESSIONS
Shows sessions that started but never ended (teaching the Ctrl+C problem).

**Use for**: Understanding incomplete sessions, resilience patterns
**Key insight**: ~80% of sessions are orphaned due to Ctrl+C exits

**Example queries**:
- "Show orphaned sessions"
- "Why are sessions incomplete?"
- "Find sessions without end events"

### V_META_LEARNING
Identifies sessions where users are studying the system itself.

**Use for**: Recursive learning analysis, meta-usage patterns
**Identifies**: Sessions querying their own usage

**Example queries**:
- "Show meta-learning sessions"
- "Find sessions analyzing Claude usage"
- "Who's studying the system?"

### V_SYSTEM_EVOLUTION
Tracks how the system improves over time.

**Use for**: System maturity, adoption curves, improvement tracking
**Metrics**: Orphan rate trends, query complexity, user sophistication

### V_QUERY_COMPLEXITY
Analyzes the sophistication of user queries.

**Use for**: User skill progression, training needs
**Metrics**: Query types, complexity scores

### V_TOOL_USAGE_PATTERNS
Breakdown of which Claude tools are used most.

**Use for**: Feature adoption, tool optimization
**Common tools**: bash, file_read, file_edit, grep, web_fetch

### V_USER_PROGRESS
Individual learning journey tracking.

**Use for**: Personal dashboards, skill development
**Metrics**: Sessions over time, tools mastered, query evolution

### V_COST_FANTASY
Intentionally inaccurate cost estimates (teaching data quality).

**Use for**: Understanding why accurate cost tracking is hard
**Note**: Estimates are deliberately wrong to teach validation

## Query Patterns

### For Session Analysis
```sql
-- Active sessions (not yet ended)
SELECT * FROM ACTIVITY_STREAM 
WHERE activity = 'claude_session_start'
  AND customer NOT IN (
    SELECT customer FROM ACTIVITY_STREAM 
    WHERE activity = 'claude_session_end'
  );
```

### For Time-Based Analysis
```sql
-- Today's activities
WHERE DATE(ts) = CURRENT_DATE()

-- Last hour
WHERE ts > DATEADD('hour', -1, CURRENT_TIMESTAMP())

-- This week
WHERE ts > DATEADD('week', -1, CURRENT_TIMESTAMP())
```

### For Meta-Queries
```sql
-- Find cq-generated queries
WHERE activity = 'claude_meta_query'

-- Recursive learning (queries about queries)
WHERE feature_json:prompt::STRING LIKE '%query%'
```

## Common Executive Questions → SQL Mappings

"How many sessions today?" → Count distinct customer WHERE DATE(ts) = CURRENT_DATE()
"What's our usage trend?" → V_EXECUTIVE_SUMMARY with time grouping
"Which users are most active?" → GROUP BY anonymous_customer_id, COUNT(*)
"What tools are used most?" → WHERE activity = 'claude_tool_use', parse feature_json
"Show orphaned sessions" → V_LEARNING_ORPHANED_SESSIONS
"Calculate costs" → V_COST_FANTASY (note: intentionally inaccurate)

## Important Context
- Sessions often lack end events due to Ctrl+C (80% orphan rate)
- The system is designed for learning, not production metrics
- "Bugs" like orphaned sessions are intentional teaching moments
- Meta-queries (queries about queries) are logged for recursive learning